
import { AkinatorState, MentorProfile } from './types';
import { MENTORS, ENIGMAS } from './constants';

export const selectMentor = (answers: AkinatorState): string => {
  const { contentType, objective, style, channel, theme } = answers;
  
  // Regras espec√≠ficas baseadas na nova l√≥gica
  if (contentType === 'video' && objective === 'vender' && style === 'direto') {
    return 'diretoEscassez';
  }
  if (contentType === 'video' && style === 'emocional') {
    return 'storytellingEmocional';
  }
  if (contentType === 'image' && style === 'criativo') {
    return 'criativoPoetico';
  }
  if (contentType === 'carousel' && style === 'did√°tico') {
    return 'didaticoPassoAPasso';
  }
  if (objective === 'leads' && style === 'direto') {
    return 'tecnicoEstruturado';
  }
  if (style === 'humoristico') {
    return 'humorViral';
  }
  if (style === 'publicit√°rio') {
    return 'criativoInstitucional';
  }
  if (style === 'institucional') {
    return 'estrategicoRacional';
  }
  
  // Fallback para outros casos
  if (style === 'provocativo') return 'diretoEscassez';
  if (objective === 'ensinar') return 'didaticoPassoAPasso';
  if (objective === 'posicionar') return 'estrategicoRacional';
  
  return 'tecnicoEstruturado';
};

export const generateSpecificScript = (answers: AkinatorState, mentorKey: string) => {
  const mentor = MENTORS[mentorKey];
  const { contentType, objective, style, channel, theme } = answers;
  
  let gancho = "";
  let conflito = "";
  let virada = "";
  let cta = "";

  if (mentorKey === 'diretoEscassez') {
    gancho = "87% das pessoas perdem R$ 3.200 por m√™s sem saber desta estrat√©gia";
    conflito = "Voc√™ trabalha 12 horas por dia, mas seu faturamento n√£o cresce porque est√° usando m√©todos ultrapassados";
    virada = "Quando apliquei o funil de convers√£o otimizado, meu ticket m√©dio saltou de R$ 150 para R$ 890 em 30 dias";
    cta = "Clica no link da bio e baixa a planilha que uso para calcular ROI de cada cliente";
  } else if (mentorKey === 'storytellingEmocional') {
    gancho = "Minha filha de 8 anos me perguntou: 'Pai, por que voc√™ chora olhando o celular?'";
    conflito = "Eu acabara de receber a mensagem de uma m√£e dizendo que nosso tratamento salvou a autoestima da filha dela";
    virada = "Percebi que n√£o estava s√≥ vendendo procedimentos, estava devolvendo a confian√ßa que essas mulheres perderam";
    cta = "Se voc√™ tamb√©m quer transformar vidas enquanto cresce profissionalmente, me chama no direct";
  } else if (mentorKey === 'criativoPoetico') {
    gancho = "Transformei um rosto cansado numa obra de arte que respira juventude";
    conflito = "Muitas pessoas acham que beleza √© superficial, mas esquece que autoestima impacta toda nossa vida";
    virada = "Com HIFU 4D n√£o invasivo, voc√™ conquista o resultado de cirurgia sem os riscos e o tempo de recupera√ß√£o";
    cta = "Marca aquela amiga que merece se sentir radiante todos os dias";
  } else if (mentorKey === 'didaticoPassoAPasso') {
    gancho = "Vou te ensinar em 3 passos como aumentar suas vendas em 40% este m√™s";
    conflito = "90% dos empreendedores fazem prospec√ß√£o errada porque n√£o sabem qualificar leads de verdade";
    virada = "Passo 1: Mapeie a dor real. Passo 2: Apresente solu√ß√£o espec√≠fica. Passo 3: Crie urg√™ncia genu√≠na";
    cta = "Salva este post e aplica hoje mesmo na sua estrat√©gia de vendas";
  } else if (mentorKey === 'tecnicoEstruturado') {
    gancho = "Analisei 847 campanhas e descobri o padr√£o que 95% ignora";
    conflito = "Voc√™ investe em an√∫ncios, mas seu CAC est√° alto porque n√£o otimiza a jornada de convers√£o";
    virada = "Implementando pixel de convers√£o + lookalike audience + landing page focada, reduzi CAC em 60%";
    cta = "Quer acesso ao meu checklist de otimiza√ß√£o? Link na bio";
  } else if (mentorKey === 'humorViral') {
    gancho = "Gente, eu descobri por que minha sobrancelha estava mais torta que pol√≠tica brasileira";
    conflito = "Fui numa 'profissional' que cobrou R$ 80 e me deixou parecendo personagem de desenho animado";
    virada = "Quando encontrei uma micropigmentadora certificada, gastei R$ 300 mas economizei minha dignidade";
    cta = "Comenta A√ç quem j√° passou vergonha com procedimento barato";
  } else if (mentorKey === 'criativoInstitucional') {
    gancho = "Inova√ß√£o n√£o √© sobre tecnologia. √â sobre resolver problemas reais de forma elegante";
    conflito = "O mercado de est√©tica est√° saturado de promessas vazias e resultados mediocres";
    virada = "Nossa abordagem combina ci√™ncia avan√ßada com cuidado humanizado para resultados que honram sua ess√™ncia";
    cta = "Agende sua consulta e descubra como a verdadeira transforma√ß√£o acontece";
  } else { // estrategicoRacional
    gancho = "ROI de 340% em procedimentos est√©ticos: os n√∫meros que sua cl√≠nica precisa conhecer";
    conflito = "Cl√≠nicas faturam pouco porque tratam est√©tica como gasto, n√£o como investimento estrat√©gico";
    virada = "Implementando protocolos baseados em evid√™ncias e fideliza√ß√£o inteligente, triplicamos o LTV dos pacientes";
    cta = "Baixe nossa an√°lise completa de mercado no link da bio";
  }

  const enigma = getRandomEnigma();
  
  return `üé¨ Gancho:\n${gancho}\n\nüéØ Conflito:\n${conflito}\n\nüîÅ Virada:\n${virada}\n\nüì£ CTA:\n${cta}\n\nüîÆ Enigma do Mentor:\n"${enigma}"\n\n‚ú® Assinatura do Roteirista:\n"Feito com alma para vender com prop√≥sito."`;
};

export const generateDisneyScript = (originalScript: string, contentType?: string, generationData?: any): string => {
  // Parse the original script to extract components
  const lines = originalScript.split('\n');
  let gancho = "";
  let conflito = "";
  let virada = "";
  let cta = "";
  
  // Extract existing components for transformation
  lines.forEach(line => {
    if (line.includes('Gancho:')) {
      gancho = line.replace(/.*Gancho:\s*/, '');
    } else if (line.includes('Conflito:')) {
      conflito = line.replace(/.*Conflito:\s*/, '');
    } else if (line.includes('Virada:')) {
      virada = line.replace(/.*Virada:\s*/, '');
    } else if (line.includes('CTA:')) {
      cta = line.replace(/.*CTA:\s*/, '');
    }
  });

  // Criar contexto a partir dos dados de gera√ß√£o
  const objetivo = generationData?.objective || 'engajar';
  const tema = generationData?.theme || 'conte√∫do criativo';
  const canal = generationData?.channel || 'redes sociais';
  const estilo = generationData?.style || 'criativo';
  const tom = 'encantador e emocional';
  const data_sazonal_ou_simbolismo = 'transforma√ß√£o pessoal';

  // Aplicar o prompt Walt Disney 1928 completo
  const disneyPromptContext = `
üéØ Objetivo: ${objetivo}
üßµ Tema: ${tema}  
üì± Canal: ${canal}
üé® Estilo: ${estilo}
üó£Ô∏è Tom desejado: ${tom}
üåü Emo√ß√£o associada: ${data_sazonal_ou_simbolismo}

Script original analisado por Walt Disney em 1928:
${originalScript}
  `;

  // Aplicar transforma√ß√£o Disney com base no tipo de conte√∫do
  let eraUmaVez = "";
  let ateQueUmDia = "";
  let entaoElaDescobriu = "";
  let eElesViveramFelizes = "";

  // Diferentes abordagens baseadas no tema e objetivo
  const disneyTransformations = [
    {
      eraUmaVez: "Era uma vez algu√©m que acreditava que j√° tinha encontrado tudo o que precisava na vida...",
      ateQueUmDia: "At√© que um dia percebeu que estava vivendo apenas uma pequena parte do que realmente merecia experimentar.",
      entaoElaDescobriu: "Ent√£o ela descobriu algo que n√£o apenas mudou sua realidade, mas despertou sonhos que nem sabia que tinha dentro de si.",
      eElesViveramFelizes: "E eles viveram felizes sabendo que a verdadeira magia acontece quando encontramos exatamente o que nossa alma estava procurando."
    },
    {
      eraUmaVez: "Era uma vez uma pessoa que se sentia exatamente como voc√™ se sente agora, em busca de algo especial...",
      ateQueUmDia: "At√© que um dia, cansada de tentar solu√ß√µes que prometiam muito mas entregavam pouco, quase desistiu de sonhar.",
      entaoElaDescobriu: "Ent√£o ela descobriu que a verdadeira transforma√ß√£o n√£o vem de fora, mas de encontrar algu√©m que realmente entende sua jornada.",
      eElesViveramFelizes: "E eles viveram felizes descobrindo que alguns encontros mudam nossa vida para sempre, de formas que jamais imaginamos poss√≠vel."
    },
    {
      eraUmaVez: "Era uma vez algu√©m que olhava no espelho e via apenas o que faltava, nunca o que j√° era belo...",
      ateQueUmDia: "At√© que um dia entendeu que a verdadeira beleza n√£o √© sobre perfei√ß√£o, mas sobre se sentir genuinamente bem consigo mesma.",
      entaoElaDescobriu: "Ent√£o ela descobriu que quando encontramos o cuidado certo, n√£o mudamos quem somos - revelamos quem sempre fomos.",
      eElesViveramFelizes: "E eles viveram felizes sabendo que a autoestima n√£o √© sobre agradar outros, mas sobre se orgulhar do que v√™ no espelho."
    }
  ];

  // Selecionar transforma√ß√£o baseada no tema ou aleatoriamente
  let selectedTransformation;
  if (tema.toLowerCase().includes('beleza') || tema.toLowerCase().includes('est√©tica')) {
    selectedTransformation = disneyTransformations[2];
  } else if (objetivo.toLowerCase().includes('vender') || objetivo.toLowerCase().includes('converter')) {
    selectedTransformation = disneyTransformations[1];
  } else {
    selectedTransformation = disneyTransformations[0];
  }

  // Aplicar limita√ß√µes de palavras baseadas no tipo de conte√∫do
  if (contentType === 'carousel') {
    selectedTransformation.eraUmaVez = "Era uma vez algu√©m que acreditava ter encontrado tudo...";
  } else if (contentType === 'video') {
    selectedTransformation.eraUmaVez = "Era uma vez algu√©m que se sentia exatamente como voc√™ agora...";
  }

  // Adicionar elementos √∫nicos Disney
  const elementoUnico = getRandomDisneyElement();
  const licaoUniversal = getRandomUniversalLesson();

  return `üé¨ Era uma vez...
${selectedTransformation.eraUmaVez}

üéØ At√© que um dia...
${selectedTransformation.ateQueUmDia}

üîÅ Ent√£o ela descobriu...
${selectedTransformation.entaoElaDescobriu}

üì£ E eles viveram felizes...
${selectedTransformation.eElesViveramFelizes}

‚ú® Elemento Disney √önico:
${elementoUnico}

üè∞ Li√ß√£o Universal:
${licaoUniversal}

üé† Assinado com magia Disney 1928
"${getRandomDisneySignature()}"`;
};

const getRandomDisneyElement = (): string => {
  const elements = [
    "Como um castelo que se revela aos poucos, a verdadeira transforma√ß√£o acontece camada por camada.",
    "Assim como Mickey encontrou sua voz, voc√™ tamb√©m pode encontrar sua ess√™ncia mais aut√™ntica.",
    "√â como descobrir uma porta secreta no seu pr√≥prio castelo - sempre esteve l√°, esperando ser aberta.",
    "Como uma estrela cadente que realiza desejos, alguns momentos mudam nossa hist√≥ria para sempre."
  ];
  return elements[Math.floor(Math.random() * elements.length)];
};

const getRandomUniversalLesson = (): string => {
  const lessons = [
    "Toda grande jornada come√ßa com um √∫nico passo corajoso em dire√ß√£o ao que realmente desejamos.",
    "A magia mais poderosa √© aquela que nos ajuda a enxergar nossa pr√≥pria luz interior.",
    "Os sonhos mais belos s√£o aqueles que nos transformam no processo de realiz√°-los.",
    "√Äs vezes, o que procuramos no mundo todo estava dentro de n√≥s desde o in√≠cio."
  ];
  return lessons[Math.floor(Math.random() * lessons.length)];
};

const getRandomDisneySignature = (): string => {
  const signatures = [
    "Onde h√° sonhos, h√° sempre um caminho para torn√°-los realidade.",
    "A verdadeira magia acontece quando acreditamos no imposs√≠vel.",
    "Todo final feliz come√ßa com a coragem de dar o primeiro passo.",
    "As hist√≥rias mais belas s√£o aquelas que vivemos quando ousamos sonhar.",
    "Em cada cora√ß√£o existe um castelo esperando para ser descoberto."
  ];
  return signatures[Math.floor(Math.random() * signatures.length)];
};

export const getRandomEnigma = (): string => {
  const newEnigmas = [
    "Quem entende narrativa, sente a assinatura.",
    "Feito pra vender. Mas com alma.",
    "Isso aqui tem mais que copy. Tem viv√™ncia.",
    "Foi s√≥ uma virada... mas mudou tudo."
  ];
  return newEnigmas[Math.floor(Math.random() * newEnigmas.length)];
};
